# QZ Tray Setup Instructions

## What is QZ Tray?
QZ Tray is a free, open-source software that allows web browsers to communicate directly with thermal printers and cash drawers. It runs as a background service on your computer.

## Installation Steps

### Step 1: Download QZ Tray
1. Go to: https://qz.io/download/
2. Click **"Download for Windows"**
3. Download the `.exe` installer (approximately 50MB)

### Step 2: Install QZ Tray
1. Run the downloaded `.exe` file
2. Follow the installation wizard:
   - Click **Next**
   - Accept the license agreement
   - Choose installation location (default is fine)
   - Click **Install**
   - Click **Finish**

### Step 3: Verify Installation
1. **QZ Tray will auto-start** after installation
2. Look for the **QZ Tray icon** in your system tray (bottom-right corner of Windows taskbar)
   - Icon looks like a small printer/receipt
3. Right-click the icon → **About** to see version info

### Step 4: Trust the AKM-POS Website
1. Open your browser and go to: **https://akm-daily.web.app**
2. When you print your **first Cash invoice**, you'll see a QZ Tray popup:
   - **"Allow akm-daily.web.app to connect?"**
   - Click **"Allow Always"** (or **"Remember This Decision"**)
3. This only needs to be done once

## How It Works

### Cash Drawer Functionality
- When you select **Cash** as payment method and print an invoice:
  1. Receipt prints to your thermal printer
  2. QZ Tray sends ESC/POS command: `\x1B\x70\x00\x19\xFA`
  3. Cash drawer kicks open automatically (500ms after print starts)

### Cash Drawer Must Be:
- ✅ Connected to your thermal printer's **RJ11/RJ12 cash drawer port**
- ✅ Compatible with ESC/POS commands (most are)
- ✅ Enabled in printer settings (check your printer's manual)

## Troubleshooting

### Cash Drawer Not Opening?

**1. Check Physical Connection:**
- Ensure cash drawer cable is firmly plugged into printer's RJ11 port
- Try a different RJ11 cable if available

**2. Check Printer Settings:**
- Some printers require enabling cash drawer in their settings
- Consult your thermal printer manual for "Cash Drawer Enable" setting

**3. Check QZ Tray Status:**
- Look for QZ Tray icon in system tray
- If missing, restart QZ Tray:
  - **Start Menu** → Search "QZ Tray" → Run the application

**4. Check Browser Console:**
```javascript
// Open browser console (F12)
// Look for these messages:
✅ "Connected to QZ Tray"
✅ "Cash drawer command sent successfully"
❌ "QZ Tray library not loaded"
❌ "No printers found"
```

**5. Different ESC/POS Commands:**
Some printers use different commands. If drawer doesn't open, try editing `app.js`:
```javascript
// Current command (works for most printers):
const escPos = '\x1B\x70\x00\x19\xFA'; // ESC p 0 25 250

// Alternative commands to try:
// Pin 5 instead of Pin 2:
const escPos = '\x1B\x70\x01\x19\xFA'; // ESC p 1 25 250

// Shorter pulse:
const escPos = '\x1B\x70\x00\x0F\x0F'; // ESC p 0 15 15

// Star Micronics printers:
const escPos = '\x07'; // BEL command
```

### QZ Tray Not Running?
```bash
# Check if QZ Tray is running:
tasklist | grep -i qz

# Start QZ Tray manually:
# Start Menu → QZ Tray
```

### Website Not Connecting to QZ Tray?
1. Clear browser cache and reload page
2. Check Windows Firewall isn't blocking QZ Tray
3. Reinstall QZ Tray (download latest version)

## Testing Cash Drawer

### Quick Test:
1. Open https://akm-daily.web.app
2. Create a test invoice with **Cash** payment
3. Click **Print Invoice**
4. Receipt should print AND drawer should open

### Manual Test (Browser Console):
```javascript
// Open browser console (F12) and paste:
qz.websocket.connect().then(() => {
  return qz.printers.find();
}).then((printers) => {
  console.log('Printers:', printers);
  const config = qz.configs.create(printers[0]);
  return qz.print(config, ['\x1B\x70\x00\x19\xFA']);
}).then(() => {
  console.log('Drawer should open!');
});
```

## Uninstall QZ Tray
If you need to uninstall:
1. **Windows Settings** → **Apps** → Search "QZ Tray"
2. Click **Uninstall**

## Support
- QZ Tray Documentation: https://qz.io/wiki/
- QZ Tray GitHub: https://github.com/qzind/tray
- AKM-POS Support: Contact your system administrator

---

**Note:** QZ Tray must be running for cash drawer to work. It starts automatically on Windows boot after installation.
